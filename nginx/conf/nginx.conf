# ./nginx/nginx.conf

# Número de procesos worker (auto = detecta CPU cores automáticamente)
worker_processes auto;

# Archivo de log de errores y nivel de logging
# Niveles: debug, info, notice, warn, error, crit, alert, emerg
error_log /var/log/nginx/error.log warn;

# Archivo donde se guarda el PID del proceso principal
pid /var/run/nginx.pid;

# CONFIGURACIÓN DE EVENTOS
# Controla cómo nginx maneja las conexiones
events {
    # Número máximo de conexiones simultáneas por worker process
    # Total conexiones = worker_processes × worker_connections
    worker_connections 1024;
}

# CONFIGURACIÓN HTTP
# Todo lo relacionado con el servidor web
http {
    # TIPOS DE ARCHIVO Y CONTENIDO
    # Incluye el archivo que mapea extensiones a tipos MIME
    # (.html → text/html, .css → text/css, etc.)
    include /usr/local/openresty/nginx/conf/mime.types;
    
    # Tipo MIME por defecto para archivos desconocidos
    default_type application/octet-stream;

    # CONFIGURACIÓN DE LOGS
    # Define el formato de los logs de acceso
    # $remote_addr = IP del cliente
    # $remote_user = usuario autenticado (si hay)
    # $time_local = timestamp local
    # $request = método HTTP + URL + versión
    # $status = código de respuesta HTTP
    # $body_bytes_sent = bytes enviados (sin headers)
    # $http_referer = página desde donde vino el usuario
    # $http_user_agent = navegador del usuario
    # $http_x_forwarded_for = IP real si hay proxy
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    # Archivo de log de acceso usando el formato definido arriba
    access_log /var/log/nginx/access.log main;

    # OPTIMIZACIONES DE RENDIMIENTO
    # Usa sendfile() del kernel para enviar archivos (más eficiente)
    sendfile on;
    
    # Optimiza el envío de paquetes TCP (solo con sendfile on)
    tcp_nopush on;
    
    # Deshabilita el algoritmo de Nagle para conexiones keep-alive
    tcp_nodelay on;
    
    # Tiempo que mantiene abiertas las conexiones keep-alive (segundos)
    keepalive_timeout 65;
    
    # Tamaño máximo de la tabla hash para tipos MIME
    types_hash_max_size 2048;

    # INCLUIR CONFIGURACIONES ESPECÍFICAS
    # Esta línea es CRÍTICA: incluye todos los archivos .conf de conf.d/
    # Sin esta línea, tu api.conf no se cargaría
    include /etc/nginx/conf.d/*.conf;
}